<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Regalos Baby Shower</title>
    <!-- Previous CSS remains unchanged -->
</head>
<body>
    <!-- Previous HTML structure remains unchanged -->

    <script src="https://cdnjs.cloudflare.com/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Modified script to use Local Storage

        // Initialize giftData from Local Storage or use default data
        let giftData = JSON.parse(localStorage.getItem('giftData')) || [
            // Your original giftData array here (unchanged)
            { id: 1, name: "kit de aseo", description: "kit de aseo (cepillo de pelo, cortauñas etc)", price: "", reserved: false, reservedBy: "" },
            // ... rest of the original array
        ];

        // Initialize users from Local Storage
        let users = JSON.parse(localStorage.getItem('users')) || [];

        // Function to save giftData to Local Storage
        function saveGiftData() {
            localStorage.setItem('giftData', JSON.stringify(giftData));
        }

        // Function to save users to Local Storage
        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
        }

        // Modify login button event listener to use Local Storage
        loginButton.addEventListener('click', () => {
            const fullName = document.getElementById('full-name-input').value.trim();
            const email = emailInput.value.trim();
            
            if (!fullName) {
                loginError.textContent = "Por favor, introduce tu nombre completo.";
                return;
            }

            if (!validateEmail(email)) {
                loginError.textContent = "Por favor, introduce un correo electrónico válido.";
                return;
            }

            loginError.textContent = "";
            currentUser = { fullName, email };

            // Store the user's name and email in local storage
            localStorage.setItem('fullName', fullName);
            localStorage.setItem('email', email);
            
            // Verificar si el usuario ya existe, si no, agregarlo
            if (!users.some(user => user.email === email)) {
                users.push(currentUser);
                saveUsers(); // Save updated users to Local Storage
            }

            userEmailSpan.textContent = email;
            confirmationEmailSpan.textContent = email;

            loginSection.style.display = 'none';
            giftListSection.style.display = 'block';

            // Cargar lista de regalos
            renderGiftList();
        });

        // Modify selectGift function to update Local Storage
        function selectGift(giftId) {
            const gift = giftData.find(g => g.id === giftId);
            
            if (gift && !gift.reserved) {
                gift.reserved = true;
                // Retrieve the full name from local storage
                const reservedBy = localStorage.getItem('fullName');
                gift.reservedBy = reservedBy;
                
                selectedGiftSpan.textContent = gift.name;
                
                giftListSection.style.display = 'none';
                thankYouSection.style.display = 'block';
                
                // Save updated gift data to Local Storage
                saveGiftData();
                
                // Actualizar tabla de administrador
                updateGiftsTable();
            }
        }

        // Modify editGift function to save to Local Storage
        function editGift(giftId) {
            const rows = document.querySelectorAll('#gifts-table-body tr');
            const row = Array.from(rows).find(r => r.querySelector(`button[onclick="editGift(${giftId})"]`));
            
            const name = row.cells[0].textContent;
            const description = row.cells[1].textContent;
            const price = row.cells[2].textContent;

            const gift = giftData.find(g => g.id === giftId);
            if (gift) {
                gift.name = name;
                gift.description = description;
                gift.price = price;
                
                // Save updated gift data to Local Storage
                saveGiftData();
                
                // Render the updated list
                renderGiftList();
                updateGiftsTable();
            }
        }

        // Modify deleteGift function to save to Local Storage
        function deleteGift(giftId) {
            giftData = giftData.filter(g => g.id !== giftId);
            
            // Save updated gift data to Local Storage
            saveGiftData();
            
            // Re-render the tables
            renderGiftList();
            updateGiftsTable();
        }

        // Modify new gift form submission to save to Local Storage
        newGiftForm.addEventListener('submit', (event) => {
            event.preventDefault();
            
            const newGiftName = document.getElementById('new-gift-name').value.trim();
            const newGiftDescription = document.getElementById('new-gift-description').value.trim();
            const newGiftPrice = document.getElementById('new-gift-price').value.trim();
            
            if (newGiftName && newGiftDescription && newGiftPrice) {
                const newGift = {
                    id: giftData.length + 1,
                    name: newGiftName,
                    description: newGiftDescription,
                    price: newGiftPrice,
                    reserved: false,
                    reservedBy: ""
                };
                
                giftData.push(newGift);
                
                // Save updated gift data to Local Storage
                saveGiftData();
                
                renderGiftList();
                updateGiftsTable();
                
                // Clear the form
                newGiftForm.reset();
            } else {
                alert("Por favor, completa todos los campos.");
            }
        });

        // Modify logout function to clear Local Storage as needed
        function logout() {
            currentUser = null;
            emailInput.value = '';
            
            // Clear specific local storage items
            localStorage.removeItem('fullName');
            localStorage.removeItem('email');
            
            loginSection.style.display = 'block';
            giftListSection.style.display = 'none';
            thankYouSection.style.display = 'none';
            adminPanel.style.display = 'none';
        }

        // Initialize the application with data from Local Storage
        function initializeApp() {
            // Restore user session if exists
            const savedEmail = localStorage.getItem('email');
            const savedFullName = localStorage.getItem('fullName');

            if (savedEmail && savedFullName) {
                currentUser = { fullName: savedFullName, email: savedEmail };
                userEmailSpan.textContent = savedEmail;
                confirmationEmailSpan.textContent = savedEmail;

                loginSection.style.display = 'none';
                giftListSection.style.display = 'block';
            }

            // Render gift list and table
            renderGiftList();
            updateGiftsTable();
        }

        // Call initialization when the page loads
        initializeApp();
    </script>
</body>
</html>
